---
const urlPath = Astro.url.pathname;

// Normalizamos (quita slash final excepto "/")
const path = urlPath !== "/" ? urlPath.replace(/\/$/, "") : "/";

const isHome = path === "/";
const isBlog = path === "/blog" || path.startsWith("/blog/");
const isSoftware = path.startsWith("/software-development");
const isDevops = path.startsWith("/devops");
const isPersonal = path.startsWith("/personal-projects");
---

<aside
  id="site-sidebar"
  data-animation="default"
  data-collapse="medium"
  data-duration="400"
  data-easing="ease"
  data-easing2="ease"
  role="banner"
  class="sidebar w-nav"
>

  <div class="nav-content">
    <a href="/" class="w-nav-brand" aria-label="home">
      <div class="niv-data">
        <img
          src="/assets/alan.jpg"
          loading="eager"
          alt="Profile picture"
          class="niv-image"
        />
        <div>
          <div class="label-white">Alan López</div>
          <div class="label-gray">Web Dev · QA &amp; Testing</div>
        </div>
      </div>
    </a>

<nav role="navigation" class="w-nav-menu" data-menu-panel>
      <a
        href="/"
        class={`nav-link-container w-inline-block ${isHome ? "w--current" : ""}`}
        aria-current={isHome ? "page" : undefined}
      >
        <img
          src="/assets/home.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>Home</div>
      </a>

      <a
        href="/blog"
        class={`nav-link-container w-inline-block ${isBlog ? "w--current" : ""}`}
        aria-current={isBlog ? "page" : undefined}
      >
        <img
          src="/assets/favorite.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>Blog</div>
      </a>

      <a
        href="/software-development"
        class={`nav-link-container w-inline-block ${isSoftware ? "w--current" : ""}`}
        aria-current={isSoftware ? "page" : undefined}
      >
        <img
          src="/assets/code.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>Software development</div>
      </a>

      <a
        href="/devops"
        class={`nav-link-container w-inline-block ${isDevops ? "w--current" : ""}`}
        aria-current={isDevops ? "page" : undefined}
      >
        <img
          src="/assets/dns.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>QA &amp; Tooling</div>
      </a>

      <a
        href="/personal-projects"
        class={`nav-link-container w-inline-block ${isPersonal ? "w--current" : ""}`}
        aria-current={isPersonal ? "page" : undefined}
      >
        <img
          src="/assets/favorite.svg"
          loading="eager"
          alt=""
          class="nav-link-image"
        />
        <div>Personal projects</div>
      </a>
    </nav>

   <button
  type="button"
  class="navbar-icon-button w-nav-button"
  aria-label="menu"
  aria-expanded="false"
  data-nav-toggle
>
  <img
    src="/assets/menu.svg"
    loading="eager"
    alt=""
    class="navbar-icon"
  />
</button>

  </div>
  <div class="mobile-overlay" data-overlay></div>
</aside>

<script is:inline>
  const root = document.getElementById("site-sidebar");
  if (!root) return;

  const toggle = root.querySelector("[data-nav-toggle]");
  const panel  = root.querySelector("[data-menu-panel]");
  const overlay = root.querySelector("[data-overlay]");

  // Debug mínimo (por si algo no existe)
  // console.log("sidebar init", { root, toggle, panel, overlay });

  if (!toggle || !panel || !overlay) return;

  const isOpen = () => root.classList.contains("is-open");

  const setOpen = (open) => {
    root.classList.toggle("is-open", open);
    toggle.setAttribute("aria-expanded", String(open));
    document.body.style.overflow = open ? "hidden" : "";
  };

  toggle.addEventListener("pointerup", (e) => {
  e.preventDefault();
  e.stopPropagation();
  setOpen(!isOpen());
});


  // Soporte iOS: algunos taps no disparan click si hay capas raras
  toggle.addEventListener("touchend", (e) => {
    e.preventDefault();
    e.stopPropagation();
    setOpen(!isOpen());
  }, { passive: false });

  overlay.addEventListener("click", () => setOpen(false));
  overlay.addEventListener("touchend", (e) => {
    e.preventDefault();
    setOpen(false);
  }, { passive: false });

  panel.querySelectorAll("a").forEach((a) => {
    a.addEventListener("click", () => setOpen(false));
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") setOpen(false);
  });
</script>
